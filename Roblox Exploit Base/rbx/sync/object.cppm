module;

#include <cstdint>
#include <cstddef>

export module rbx.object;

import rbx.constants;

export namespace rbx {
	struct State;

	struct Table {
		std::uint8_t _[9];
		std::uint8_t readonly;
	};
	
	union GCObject {
		std::uintptr_t s;
		rbx::Table* h;
		rbx::State* th;
	};

	struct TValue {
		union {
			GCObject* gc;
			void* p;
			std::uint64_t n_xor;
			bool b;
		} value;
		std::uintptr_t _;
		int tt;
	};

	struct State {
		std::uint8_t _[20];
		rbx::TValue* top;
		rbx::TValue* base;
	};

	using CFunction = int(*)(State*);

	auto hvalue = [](rbx::TValue* obj) {
		return obj->value.gc->h;
	};

	auto thvalue = [](rbx::TValue* obj) {
		return obj->value.gc->th;
	};

	auto svalue = [](rbx::TValue* obj) {
		return obj->value.gc->s;
	};

	auto setnvalue = [](rbx::TValue* obj, double val, uint64_t cipher) {
		obj->value.n_xor = cipher ^ *reinterpret_cast<uint64_t*>(&val);
		obj->tt = rbx::TNUMBER;
	};
	
	auto setbvalue = [](rbx::TValue* obj, bool b) {
		obj->value.b = b;
		obj->tt = rbx::TBOOLEAN;
	};

	auto setsvalue = [](rbx::TValue* obj, std::uintptr_t s) {
		obj->value.gc->s = s;
		obj->tt = rbx::TSTRING;
	};

	auto sethvalue = [](rbx::TValue* obj, rbx::Table* h) {
		obj->value.gc->h = h;
		obj->tt = rbx::TTABLE;
	};

	auto setpvalue = [](rbx::TValue* obj, void* p) {
		obj->value.p = p;
		obj->tt = rbx::TLIGHTUSERDATA;
	};

	auto setobj = [](rbx::TValue* obj, rbx::TValue* obj2) {
		*obj = *obj2;
	};

	auto setnilvalue = [](rbx::TValue* obj) {
		obj->tt = rbx::TNIL;
	};

	auto rawstrvalue = [](rbx::TValue* obj) {
		return reinterpret_cast<const char*>(obj->value.gc->s + 20);
	};

	auto incr_top = [](State* R) {
		*reinterpret_cast<uintptr_t*>(reinterpret_cast<uintptr_t>(R) + offsetof(State, top)) += sizeof(rbx::TValue);
	};

	auto decr_top = [](State* R) {
		*reinterpret_cast<uintptr_t*>(reinterpret_cast<uintptr_t>(R) + offsetof(State, top)) -= sizeof(rbx::TValue);
	};
}
